name: ci-helm
permissions:
  packages: write
  contents: read
on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.github/dependabot.yml'
      - '.github/workflows/ci-oras.yaml'
      - 'kustomization.yaml'
  pull_request:
    paths-ignore:
      - 'README.md'
      - '.github/dependabot.yml'
      - '.github/workflows/ci-oras.yaml'
      - 'kustomization.yaml'
env:
  CHART_NAME: my-chart
  IMAGE_TAG: 0.1.0
  CONFIG_SYNC_VERSION: 1.13.0
jobs:
  tests:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.0.2
      - name: create kind cluster
        if: ${{ always() }}
        run: |
          kind version
          # kind create cluster --image kindest/node:v1.24.6
          chmod +x .github/workflows/create-kind-cluster-with-local-registry.sh
          .github/workflows/create-kind-cluster-with-local-registry.sh
      - name: config sync install
        run: |
          kubectl apply -f https://github.com/GoogleContainerTools/kpt-config-sync/releases/download/v${CONFIG_SYNC_VERSION}/config-sync-manifest.yaml --wait
      - name: rootsync with public helm chart
        run: |
          cat << EOF | kubectl apply -f -
          apiVersion: configsync.gke.io/v1beta1
          kind: RootSync
          metadata:
            name: root-sync
            namespace: config-management-system
          spec:
            sourceFormat: unstructured
            sourceType: helm
            helm:
              repo: oci://ghcr.io/mathieu-benoit
              chart: my-chart
              version: 0.1.0
              releaseName: my-chart
              namespace: default
              auth: none
          EOF
